<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tracking Links Generator & Viewer</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
  body {
    margin: 0;
    font-family: 'Poppins', sans-serif;
    background: #121212;
    color: #eee;
    display: flex;
    flex-direction: column;
    min-height: 100vh;
  }
  header {
    background: #1f1f1f;
    padding: 1rem 2rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.6);
    text-align: center;
    font-weight: 600;
    font-size: 1.5rem;
    color: #00d8ff;
  }
  main {
    flex: 1;
    padding: 2rem;
    max-width: 900px;
    margin: 0 auto;
  }
  h2 {
    margin-top: 1rem;
    color: #00d8ff;
  }
  label {
    display: block;
    margin: 1rem 0 0.5rem;
    font-weight: 600;
  }
  input[type=text] {
    width: 100%;
    max-width: 400px;
    padding: 0.5rem 1rem;
    border: none;
    border-radius: 6px;
    font-size: 1rem;
    background: #333;
    color: #eee;
  }
  button {
    margin-top: 1rem;
    padding: 0.75rem 1.5rem;
    font-weight: 600;
    font-size: 1rem;
    background: #00d8ff;
    border: none;
    border-radius: 6px;
    color: #121212;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #008fb3;
  }
  .link-output {
    margin-top: 1rem;
    background: #222;
    padding: 1rem;
    border-radius: 6px;
    word-wrap: break-word;
  }
  section {
    margin-bottom: 3rem;
  }
  .log-container {
    background: #222;
    border-radius: 6px;
    padding: 1rem;
    max-height: 300px;
    overflow-y: auto;
    font-family: monospace;
    font-size: 0.9rem;
  }
  .log-entry {
    border-bottom: 1px solid #444;
    padding: 0.3rem 0;
  }
  .tracking-link-page {
    display: none;
    padding: 2rem;
    text-align: center;
  }
  .tracking-link-page.show {
    display: block;
  }
  .location-info {
    margin-top: 1rem;
    background: #111;
    padding: 1rem;
    border-radius: 6px;
  }
  a {
    color: #00d8ff;
    text-decoration: none;
  }
  a:hover {
    text-decoration: underline;
  }
  footer {
    text-align: center;
    padding: 1rem;
    font-size: 0.8rem;
    color: #555;
    background: #111;
  }
</style>
</head>
<body>
<header>Tracking Links Generator & Viewer</header>
<main>
  <section id="creator">
    <h2>Create Tracking Link</h2>
    <label for="trackingIdInput">Tracking ID (unique name):</label>
    <input type="text" id="trackingIdInput" placeholder="e.g. campaign123" />
    <button id="createLinkBtn">Create Link</button>
    <div class="link-output" id="linkOutput" aria-live="polite"></div>
  </section>

  <section id="logViewer">
    <h2>Tracking Logs</h2>
    <label for="selectTrackingId">Select Tracking ID:</label>
    <select id="selectTrackingId">
      <option value="">-- Select an ID --</option>
    </select>
    <div class="log-container" id="logContainer">
      No logs to display.
    </div>
  </section>
</main>

<section class="tracking-link-page" id="trackingPage">
  <h2>Tracking Link Activated</h2>
  <p id="trackingIdDisplay"></p>
  <p id="statusMessage">Requesting your location...</p>
  <div class="location-info" id="locationInfo" style="display:none;">
    <p><strong>Your Location:</strong></p>
    <p id="coords"></p>
    <p id="timestamp"></p>
  </div>
  <p>Thank you for sharing your location!</p>
  <p><a href="#" id="goBackLink">Go back to main page</a></p>
</section>

<footer>
  &copy; 2024 Tracking Links Demo - Location tracking works only if visitor allows location access in browser.
</footer>

<script>
(() => {
  const createLinkBtn = document.getElementById('createLinkBtn');
  const trackingIdInput = document.getElementById('trackingIdInput');
  const linkOutput = document.getElementById('linkOutput');
  const selectTrackingId = document.getElementById('selectTrackingId');
  const logContainer = document.getElementById('logContainer');

  const trackingPage = document.getElementById('trackingPage');
  const trackingIdDisplay = document.getElementById('trackingIdDisplay');
  const statusMessage = document.getElementById('statusMessage');
  const locationInfo = document.getElementById('locationInfo');
  const coordsDisplay = document.getElementById('coords');
  const timestampDisplay = document.getElementById('timestamp');
  const goBackLink = document.getElementById('goBackLink');

  // Base URL for tracking - this page itself with a query ?trackid=...
  const baseUrl = window.location.origin + window.location.pathname;

  // Store logs in localStorage under key "trackingLogs"
  // Data structure: { trackingId1: [{lat,lng,timestamp}, {...}], trackingId2: [...] }
  function getLogs() {
    const logsJson = localStorage.getItem('trackingLogs');
    return logsJson ? JSON.parse(logsJson) : {};
  }

  function saveLogs(logs) {
    localStorage.setItem('trackingLogs', JSON.stringify(logs));
  }

  function addLog(trackingId, location) {
    const logs = getLogs();
    if (!logs[trackingId]) logs[trackingId] = [];
    logs[trackingId].push(location);
    saveLogs(logs);
  }

  function updateSelectOptions() {
    const logs = getLogs();
    const ids = Object.keys(logs);
    selectTrackingId.innerHTML = '<option value="">-- Select an ID --</option>';
    if (ids.length === 0) {
      logContainer.textContent = 'No logs to display.';
      return;
    }
    ids.forEach(id => {
      const opt = document.createElement('option');
      opt.value = id;
      opt.textContent = id;
      selectTrackingId.appendChild(opt);
    });
    logContainer.textContent = 'Select a Tracking ID above to view logs.';
  }

  function displayLogs(trackingId) {
    const logs = getLogs();
    if (!trackingId || !logs[trackingId] || logs[trackingId].length === 0) {
      logContainer.textContent = 'No logs to display for this Tracking ID.';
      return;
    }
    logContainer.innerHTML = '';
    logs[trackingId].slice().reverse().forEach(log => {
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      const date = new Date(log.timestamp);
      entry.textContent = `Lat: ${log.lat.toFixed(5)}, Lng: ${log.lng.toFixed(5)} @ ${date.toLocaleString()}`;
      logContainer.appendChild(entry);
    });
  }

  createLinkBtn.addEventListener('click', () => {
    const id = trackingIdInput.value.trim();
    if (!id) {
      linkOutput.textContent = 'Please enter a Tracking ID.';
      return;
    }
    // sanitize id for URL usage (simple alphanumeric and hyphen, underscore)
    const safeId = id.replace(/[^a-zA-Z0-9-_]/g, '');
    if (!safeId) {
      linkOutput.textContent = 'Tracking ID must contain at least one alphanumeric character or "-" or "_".';
      return;
    }
    // Make link with ?trackid=safeId
    const link = `${baseUrl}?trackid=${encodeURIComponent(safeId)}`;
    linkOutput.innerHTML = `Tracking link ready: <a href="${link}" target="_blank" rel="noopener noreferrer">${link}</a>`;
    updateSelectOptions();
  });

  selectTrackingId.addEventListener('change', () => {
    const id = selectTrackingId.value;
    if (id) {
      displayLogs(id);
    } else {
      logContainer.textContent = 'Select a Tracking ID above to view logs.';
    }
  });

  goBackLink.addEventListener('click', e => {
    e.preventDefault();
    window.history.replaceState({}, '', baseUrl);
    trackingPage.classList.remove('show');
    document.getElementById('creator').style.display = '';
    document.getElementById('logViewer').style.display = '';
    linkOutput.textContent = '';
  });

  function showTrackingPage(id) {
    trackingIdDisplay.textContent = `Tracking ID: ${id}`;
    document.getElementById('creator').style.display = 'none';
    document.getElementById('logViewer').style.display = 'none';
    trackingPage.classList.add('show');
    locationInfo.style.display = 'none';
    statusMessage.textContent = 'Requesting your location...';

    if (!navigator.geolocation) {
      statusMessage.textContent = 'Geolocation is not supported by your browser.';
      return;
    }

    navigator.geolocation.getCurrentPosition(
      position => {
        const lat = position.coords.latitude;
        const lng = position.coords.longitude;
        const timestamp = new Date().toISOString();

        statusMessage.textContent = 'Location received!';
        locationInfo.style.display = 'block';
        coordsDisplay.textContent = `Latitude: ${lat.toFixed(5)}, Longitude: ${lng.toFixed(5)}`;
        timestampDisplay.textContent = `Timestamp: ${new Date(timestamp).toLocaleString()}`;

        // Save log for this tracking id
        addLog(id, { lat, lng, timestamp });

      },
      error => {
        statusMessage.textContent = `Unable to retrieve location: ${error.message}`;
      }, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      }
    );
  }

  // On load: check URL params for trackid, if present, show tracking page
  window.addEventListener('load', () => {
    const params = new URLSearchParams(window.location.search);
    const trackid = params.get('trackid');
    if (trackid) {
      showTrackingPage(trackid);
      updateSelectOptions();
    } else {
      updateSelectOptions();
    }
  });
})();
</script>
</body>
</html>

