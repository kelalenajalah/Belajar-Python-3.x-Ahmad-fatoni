<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Real-Time Location Tracker</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0; padding: 0;
      background: #f5f8fa;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: #333;
    }
    header {
      background: #007bff;
      color: white;
      padding: 1rem 2rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    main {
      flex: 1;
      padding: 20px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }
    label {
      font-weight: 600;
      display: block;
      margin-bottom: 8px;
    }
    input[type="text"] {
      width: 100%;
      padding: 10px;
      font-size: 1rem;
      border-radius: 5px;
      border: 1px solid #ccc;
      margin-bottom: 15px;
      box-sizing: border-box;
    }
    button {
      background-color: #007bff;
      border: none;
      color: white;
      padding: 12px 20px;
      font-size: 1rem;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      display: inline-block;
    }
    button:hover {
      background-color: #0056b3;
    }
    .link-container {
      margin-top: 15px;
      word-break: break-all;
      font-size: 1.1rem;
    }
    #map {
      height: 400px;
      width: 100%;
      border-radius: 10px;
      margin-top: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.15);
    }
    .info {
      margin-top: 15px;
      font-size: 0.9rem;
      color: #555;
      background: #e9f1ff;
      padding: 10px;
      border-radius: 5px;
      user-select: none;
    }
    .notice {
      margin-top: 10px;
      font-size: 0.9rem;
      color: #cc3300;
    }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"
    integrity="sha256-sA+4f/Ln0wM9Ed3CEi2fWnJb8GpEcYgu0bBpCJbZ5m0="
    crossorigin=""/>
</head>
<body>
  <header>Real-Time Location Tracker</header>
  <main>
    <div id="mode-container"></div>
  </main>

  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"
    integrity="sha256-pv5M8EFhrV5YYitnVHl5TlJe9ZHPt2h7ZXmguvTG0iE="
    crossorigin=""></script>

  <script>
    // Define the BroadcastChannel name
    const channelName = 'location-tracker-channel';
    // Create the channel
    const channel = new BroadcastChannel(channelName);

    // Identify mode by URL param ?track=token or ?send=token or no param
    const urlParams = new URLSearchParams(window.location.search);
    const trackToken = urlParams.get('track');
    const sendToken = urlParams.get('send');

    const main = document.querySelector('main');
    const modeContainer = document.getElementById('mode-container');

    if (!trackToken && !sendToken) {
      // Generator mode - input URL and create link with token
      modeContainer.innerHTML = `
        <label for="inputUrl">Masukkan Link (URL) untuk Dibagikan ke Pacar:</label>
        <input type="text" id="inputUrl" placeholder="https://contoh.com" />
        <button id="generateBtn">Buat Link Tracking</button>
        <div class="link-container" id="generatedLink"></div>
        <div class="info">Link tracking akan meminta lokasi setiap kali dibuka oleh pacar dan data lokasi akan tampil real-time di sini.</div>
        <div id="map"></div>
      `;

      const inputUrl = document.getElementById('inputUrl');
      const generateBtn = document.getElementById('generateBtn');
      const generatedLinkDiv = document.getElementById('generatedLink');

      // Variables for map and marker
      let map, marker;

      generateBtn.addEventListener('click', () => {
        let url = inputUrl.value.trim();
        if (!url) {
          alert('Masukkan URL yang valid.');
          return;
        }
        // Generate random token (6 chars alphanumeric)
        const token = Math.random().toString(36).substr(2, 6);
        // Create tracking link for "send" mode
        const trackingLink = window.location.origin + window.location.pathname + '?send=' + token;

        // Save token to track locally
        localStorage.setItem('trackingToken', token);

        generatedLinkDiv.innerHTML = `
          <strong>Link yang harus dikirim ke pacar:</strong><br>
          <a href="${trackingLink}" target="_blank">${trackingLink}</a><br>
          <small><i>Link ini akan meminta izin lokasi dan mengirim lokasi real-time ke halaman ini.</i></small>
        `;

        // Remove previous map if any
        if (map) {
          map.remove();
        }

        // Initialize map centered to Indonesia initially
        map = L.map('map').setView([-2.5489, 118.0149], 5);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        marker = null;

        // Listen for location data on the channel with matching token
        channel.onmessage = (event) => {
          const data = event.data;
          if (data.type === 'locationUpdate' && data.token === token) {
            const { latitude, longitude, accuracy, timestamp } = data.location;
            const timeString = new Date(timestamp).toLocaleTimeString();

            if (!marker) {
              marker = L.marker([latitude, longitude]).addTo(map);
              map.setView([latitude, longitude], 15);
            } else {
              marker.setLatLng([latitude, longitude]);
            }

            generatedLinkDiv.innerHTML += `
              <br><br>
              <strong>Lokasi terakhir diterima:</strong> ${latitude.toFixed(5)}, ${longitude.toFixed(5)}<br>
              Akurasi: ±${accuracy} meter<br>
              Waktu: ${timeString}
            `;
          }
        };

      });

    } else if (sendToken) {
      // Sender mode - page opened by pacar - request location and send periodically

      document.title = 'Tracking Location - Bagikan Lokasi Anda';

      main.innerHTML = `
        <h2>Bagikan Lokasi Anda ke Pengirim</h2>
        <p>Website ini akan meminta izin untuk mengakses lokasi Anda dan mengirim data lokasi realtime.</p>
        <p>Token Tracking: <strong>${sendToken}</strong></p>
        <div id="status" class="info">Menunggu izin lokasi...</div>
      `;

      const statusDiv = document.getElementById('status');

      let watchId = null;

      function sendLocation(position) {
        if (!position) return;
        const locationData = {
          type: 'locationUpdate',
          token: sendToken,
          location: {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            accuracy: position.coords.accuracy,
            timestamp: position.timestamp,
          }
        };
        channel.postMessage(locationData);

        statusDiv.textContent = `Lokasi terkirim: Lat=${locationData.location.latitude.toFixed(5)}, Lon=${locationData.location.longitude.toFixed(5)} (Akurasi ±${locationData.location.accuracy} meter)`;
      }

      function onLocationSuccess(position) {
        sendLocation(position);
      }

      function onLocationError(error) {
        statusDiv.textContent = 'Gagal mendapatkan lokasi: ' + error.message;
        statusDiv.classList.add('notice');
      }

      if ('geolocation' in navigator) {
        navigator.permissions.query({ name: 'geolocation' }).then(function (result) {
          if (result.state === 'granted' || result.state === 'prompt') {
            // Watch position to send updates periodically
            watchId = navigator.geolocation.watchPosition(onLocationSuccess, onLocationError, {
              enableHighAccuracy: true,
              maximumAge: 10000,
              timeout: 10000
            });
          } else {
            statusDiv.textContent = 'Izin lokasi tidak diberikan.';
            statusDiv.classList.add('notice');
          }
        });
      } else {
        statusDiv.textContent = 'Geolocation API tidak didukung oleh browser Anda.';
        statusDiv.classList.add('notice');
      }


      // Also display the tracked URL for convenience, optional
      const originalUrl = window.location.origin + window.location.pathname + '?track=' + sendToken;
      const infoDiv = document.createElement('div');
      infoDiv.className = 'info';
      infoDiv.style.marginTop = '20px';
      infoDiv.innerHTML = `
        <strong>Link Pelacakan (Hanya untuk Anda):</strong><br>
        <a href="${originalUrl}" target="_blank">${originalUrl}</a><br>
        <small>Gunakan link ini untuk melihat lokasi secara real-time (buka di perangkat Anda sendiri atau komputer Anda).</small>
      `;
      main.appendChild(infoDiv);

    } else if (trackToken) {
      // Tracker mode - open link with ?track=token to see real-time location
      document.title = 'Melacak Lokasi Pacar - Real-Time';

      main.innerHTML = `
        <h2>Melacak Lokasi Pacar</h2>
        <p>Menunggu lokasi dari partner...</p>
        <div id="map"></div>
        <div id="info" class="info"></div>
      `;

      const infoDiv = document.getElementById('info');

      let map = L.map('map').setView([-2.5489, 118.0149], 5);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; OpenStreetMap contributors'
      }).addTo(map);

      let marker = null;

      // Listen for locationUpdate messages matching token
      channel.onmessage = (event) => {
        const data = event.data;
        if (data.type === 'locationUpdate' && data.token === trackToken) {
          const { latitude, longitude, accuracy, timestamp } = data.location;
          const timeString = new Date(timestamp).toLocaleTimeString();

          if (!marker) {
            marker = L.marker([latitude, longitude]).addTo(map);
            map.setView([latitude, longitude], 15);
          } else {
            marker.setLatLng([latitude, longitude]);
          }
          
          infoDiv.innerHTML = `
            Lokasi terakhir diterima:<br>
            Latitude: ${latitude.toFixed(5)}<br>
            Longitude: ${longitude.toFixed(5)}<br>
            Akurasi: ±${accuracy} meter<br>
            Waktu: ${timeString}
          `;
        }
      };

    } else {
      main.innerHTML = '<p>Parameter URL tidak dikenali.</p>';
    }
  </script>
</body>
</html>

